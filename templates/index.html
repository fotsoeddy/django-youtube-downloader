{% extends 'base.html' %}
{% block title %}Home - YouTube Downloader{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto px-4">
    <!-- Hero Section -->
    <div class="text-center mb-12 fade-in">
        <div class="mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-600" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
            </svg>
        </div>
        
        <h1 class="text-4xl font-bold font-montserrat text-gray-800 mb-4">YouTube Video Downloader</h1>
        <p class="text-lg text-gray-600 mb-8 font-lato">Download your favorite YouTube videos in high quality with just a few clicks!</p>
        
        <!-- Download Form -->
        <form method="post" action="{% url 'download' %}" id="download-form" class="max-w-md mx-auto mb-8">
            {% csrf_token %}
            <div class="relative flex items-center shadow-lg rounded-full overflow-hidden">
                <input type="url" id="video_url" name="video_url" placeholder="Paste YouTube URL here..." 
                       class="flex-grow py-4 px-6 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="absolute right-1 bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>
            </div>
        </form>

        <!-- Circular Loader (Hidden initially) -->
        <div id="progress-section" class="hidden mb-8 flex flex-col items-center justify-center">
            <div class="relative w-20 h-20 mb-4">
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="8" />
                    <circle id="progress-circle" cx="50" cy="50" r="45" fill="none" stroke="#3b82f6" stroke-width="8" 
                            stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span id="progress-percent" class="text-sm font-semibold text-gray-700">0%</span>
                </div>
            </div>
            <p class="text-gray-600 font-medium">Processing your video...</p>
        </div>

        <!-- Login Prompt if trying to download without auth -->
        <div id="login-prompt" class="hidden p-4 bg-yellow-100 border border-yellow-400 rounded-xl mb-8 text-center">
            <p class="text-yellow-800 font-medium">Please <a href="{% url 'login' %}" class="text-blue-600 underline font-semibold">login</a> or <a href="{% url 'signup' %}" class="text-blue-600 underline font-semibold">signup</a> to download videos.</p>
        </div>
    </div>

    <!-- Sample/Public Downloads Section -->
    <h2 class="text-2xl font-bold font-montserrat text-gray-800 mb-6 text-center">Recently Downloaded Videos</h2>
    <div class="grid md:grid-cols-3 gap-6">
        {% for download in downloads %}
            <div class="bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-100">
                <div class="relative mb-4 rounded-lg overflow-hidden">
                    {% if download.thumbnail_url %}
                        <img src="{{ download.thumbnail_url }}" alt="{{ download.title }}" class="w-full h-40 object-cover">
                    {% else %}
                        <div class="w-full h-40 bg-gray-200 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                    {% endif %}
                    <div class="absolute bottom-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded-md">
                        YouTube
                    </div>
                </div>
                <h3 class="font-semibold text-gray-800 mb-2 truncate">{{ download.title|truncatechars:50 }}</h3>
                <p class="text-sm text-gray-500 mb-3">{{ download.downloaded_at|date:"M d, Y" }}</p>
                <div class="flex justify-between items-center">
                    <span class="text-xs py-1 px-2 bg-blue-100 text-blue-800 rounded-full">Downloaded</span>
                    <a href="{{ download.url }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </a>
                </div>
            </div>
        {% empty %}
            <div class="col-span-full text-center py-12 bg-gray-50 rounded-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-gray-500 text-lg">No downloads yet. Be the first to download a video!</p>
            </div>
        {% endfor %}
    </div>
</div>

<script>
class DownloadHandler {
    constructor() {
        this.form = document.getElementById('download-form');
        this.progressSection = document.getElementById('progress-section');
        this.progressCircle = document.getElementById('progress-circle');
        this.progressPercent = document.getElementById('progress-percent');
        this.loginPrompt = document.getElementById('login-prompt');
        this.circumference = 2 * Math.PI * 45;
        this.initEventListeners();
        
        // Set the stroke-dasharray and stroke-dashoffset for the circle
        this.progressCircle.style.strokeDasharray = this.circumference;
        this.progressCircle.style.strokeDashoffset = this.circumference;
    }

    initEventListeners() {
        this.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.handleSubmit();
        });
    }

    async handleSubmit() {
        const formData = new FormData(this.form);
        const videoUrl = formData.get('video_url');

        if (!videoUrl) {
            this.showToast('Please enter a YouTube URL', 'error');
            return;
        }

        try {
            this.showProgress(10); // Initial progress

            const response = await fetch(this.form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                // Check if response is JSON or HTML
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    // Handle JSON response (AJAX success)
                    const data = await response.json();
                    
                    if (data.success) {
                        // Simulate progress and redirect
                        this.simulateProgress();
                        return;
                    } else {
                        this.hideProgress();
                        this.showToast(data.error || 'Failed to process video URL', 'error');
                        return;
                    }
                } else {
                    // Handle HTML response (regular form submission - success)
                    this.simulateProgress();
                    return;
                }
            } else {
                // Handle error responses
                try {
                    const data = await response.json();
                    if (response.status === 401) {
                        this.loginPrompt.classList.remove('hidden');
                        this.hideProgress();
                        this.showToast(data.error || 'Please login to download', 'warning');
                    } else {
                        this.hideProgress();
                        this.showToast(data.error || 'Request failed', 'error');
                    }
                } catch (parseError) {
                    // If JSON parsing fails, it's likely an HTML error page
                    this.hideProgress();
                    this.showToast('Server error occurred', 'error');
                }
            }
            
        } catch (error) {
            this.hideProgress();
            this.showToast(`Network error: ${error.message}`, 'error');
        }
    }

    setProgress(percent) {
        const offset = this.circumference - (percent / 100 * this.circumference);
        this.progressCircle.style.strokeDashoffset = offset;
        this.progressPercent.textContent = percent + '%';
    }

    showProgress(percent) {
        this.progressSection.classList.remove('hidden');
        this.setProgress(percent);
    }

    hideProgress() {
        this.progressSection.classList.add('hidden');
        this.setProgress(0);
    }

    showToast(message, type = 'info') {
        if (typeof toastManager !== 'undefined' && toastManager) {
            toastManager.buildToast()
                .setMessage(message)
                .setType(type)
                .show();
        } else {
            alert(message);
        }
    }

    simulateProgress() {
        let percent = 10;
        const interval = setInterval(() => {
            percent += Math.random() * 15;
            if (percent >= 90) {
                percent = 90;
                clearInterval(interval);
                // Redirect to download page after simulation
                setTimeout(() => {
                    window.location.href = '{% url "download" %}';
                }, 1000);
            }
            this.setProgress(Math.floor(percent));
        }, 200);
    }
}

function initDownloadHandler() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => new DownloadHandler(), 100);
        });
    } else {
        setTimeout(() => new DownloadHandler(), 100);
    }
}

if (typeof toastManager !== 'undefined') {
    initDownloadHandler();
} else {
    document.addEventListener('DOMContentLoaded', () => {
        const checkToastManager = setInterval(() => {
            if (typeof toastManager !== 'undefined' || typeof window.getToastManager === 'function') {
                clearInterval(checkToastManager);
                initDownloadHandler();
            }
        }, 50);
        setTimeout(() => {
            clearInterval(checkToastManager);
            initDownloadHandler();
        }, 2000);
    });
}
</script>

<style>
/* Custom animations for the circular progress */
@keyframes growProgress {
  from { stroke-dashoffset: 283; }
  to { stroke-dashoffset: 0; }
}

#progress-circle {
  transition: stroke-dashoffset 0.3s ease;
}
</style>
{% endblock %}